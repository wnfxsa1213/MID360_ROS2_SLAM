# MID360 SLAM系统统一配置文件
# 这是系统的主配置文件，所有组件配置都将从此文件生成
# 解决配置不一致导致的轨迹飘移问题

# ============================================================================
# 系统基本信息
# ============================================================================
system:
  name: "MID360_SLAM_System"
  version: "2.0"
  description: "基于Livox MID360的实时SLAM建图系统"

# ============================================================================
# 网络配置 (统一管理，避免冲突)
# ============================================================================
network:
  # 主机网络配置
  host:
    ip: "192.168.1.50"
    interface: "enp7s0"
    gateway: "192.168.1.1"
    netmask: "255.255.255.0"

  # 雷达网络配置
  lidar:
    ip: "192.168.1.3"
    # 端口配置 - 雷达端
    lidar_ports:
      cmd_data: 56100
      push_msg: 56200
      point_data: 56300
      imu_data: 56400
      log_data: 56500
    # 端口配置 - 主机端
    host_ports:
      cmd_data: 56101
      push_msg: 56201
      point_data: 56301
      imu_data: 56401
      log_data: 56501

# ============================================================================
# 硬件标定参数 (关键：解决轨迹飘移的核心)
# ============================================================================
calibration:
  # 雷达到IMU的外参 (标准：从IMU到雷达坐标系的变换)
  lidar_to_imu:
    # 平移向量 [x, y, z] (米)
    # 来自MID360规格：IMU在点云坐标系(=雷达坐标系)下的位置 (0.011, 0.02329, -0.04412)m
    # 由于IMU与点云坐标轴一致(R_il=I)，因此 t_il 采用相同分量
    translation: [0.011, 0.02329, -0.04412]
    # 旋转矩阵 [3x3展开为9个元素]
    rotation: [1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 1.0]

  # 雷达到base_link的外参
  lidar_to_baselink:
    translation: [0.0, 0.0, 0.0]
    rotation_rpy: [0.0, 0.0, 0.0]  # roll, pitch, yaw

# ============================================================================
# 坐标系配置 (统一命名规范)
# ============================================================================
frames:
  world_frame: "odom"
  base_frame: "base_link"
  lidar_frame: "livox_frame"

# ============================================================================
# ROS话题配置
# ============================================================================
topics:
  # 输入话题
  imu: "/livox/imu"
  lidar: "/livox/lidar_filtered"  # FastLIO2使用过滤后的点云数据

  # SLAM输出话题（与协同启动的重映射一致）
  odometry: "/slam/lio_odom"
  path: "/slam/lio_path"
  body_cloud: "/slam/body_cloud"
  world_cloud: "/slam/world_cloud"
  performance: "/slam/performance_metrics"
  diagnostics: "/slam/diagnostics"

# ============================================================================
# Livox雷达驱动配置
# ============================================================================
livox_driver:
  # 数据传输格式
  xfer_format: 1                    # 0-PointCloud2, 1-自定义格式
  multi_topic: 0                    # 0-共享话题, 1-每个雷达一个话题
  data_src: 0                       # 0-雷达数据, 其他-无效
  publish_freq: 10.0                # 发布频率 (Hz)
  output_data_type: 0               # 输出数据类型
  frame_id: "livox_frame"           # 坐标系名称
  cmdline_input_bd_code: "livox0000000001"  # 设备识别码

  # 雷达特定配置
  lidar_config:
    pcl_data_type: 1                # 0-笛卡尔坐标, 1-球坐标
    pattern_mode: 0                 # 扫描模式

# ============================================================================
# FAST-LIO2 SLAM算法配置
# ============================================================================
fastlio2:
  # 基本配置
  print_time_cost: true

  # 雷达预处理参数
  lidar_filter_num: 2               # 适度降采样，降低计算与冗余
  lidar_min_range: 0.5              # 最小检测距离 (米)
  lidar_max_range: 25.0             # 最大检测距离 (米，室内优化)
  scan_resolution: 0.10             # 扫描分辨率 (米)
  map_resolution: 0.10              # 地图分辨率 (米)

  # 地图管理参数
  cube_len: 100                     # 局部地图范围 (米)
  det_range: 30                     # 检测范围 (米)
  move_thresh: 0.8                  # 运动阈值 (米)

  # IMU噪声参数 (针对MID360内置IMU优化)
  imu_noise:
    accelerometer: 0.005            # 加速度计噪声 (na)
    gyroscope: 0.005                # 陀螺仪噪声 (ng)
    acc_bias: 0.0001                # 加速度计偏置噪声 (nba)
    gyro_bias: 0.00005              # 陀螺仪偏置噪声 (nbg)

  # 算法优化参数 (防飘移关键设置)
  algorithm:
    imu_init_num: 200               # IMU初始化样本数 (提高稳定性)
    near_search_num: 10             # KNN搜索邻居数 (狭窄空间降低负载)
    ieskf_max_iter: 3               # IESKF最大迭代次数
    gravity_align: true             # 重力对齐
    esti_il: true                   # 是否估计雷达-IMU外参

  # 点云匹配参数
  point_cloud:
    lidar_cov_inv: 2000.0           # 雷达协方差逆值 (提高置信度)
    lidar_cov_scale: 1.0            # 雷达协方差缩放因子
    point_filter_num: 4             # 点云滤波数量
    converge_thresh: 0.0001         # 收敛阈值

  # 缓冲区管理参数 (内存安全和线程优化)
  buffer_management:
    max_imu_buffer_size: 1000       # IMU缓冲区最大大小
    max_lidar_buffer_size: 50       # 激光雷达缓冲区最大大小
    enable_buffer_monitoring: true  # 启用缓冲区监控和警告

# ============================================================================
# 可视化配置
# ============================================================================
visualization:
  rviz:
    auto_start: true
    config_file: "enhanced_fastlio2.rviz"
    display:
      pointcloud: true
      trajectory: true
      tf_frames: true
      imu_pose: true
      diagnostics: true

# ============================================================================
# 数据记录配置
# ============================================================================
rosbag:
  auto_record: false
  topics:
    - "/livox/lidar"
    - "/livox/imu"
    - "/slam/lio_odom"
    - "/slam/lio_path"
    - "/slam/body_cloud"
    - "/tf"
    - "/tf_static"
  output_dir: "data/rosbags"
  compression_format: "zstd"
  max_duration: 0                   # 0表示无限制

# ============================================================================
# 系统监控和调试配置
# ============================================================================
monitoring:
  performance:
    enable_metrics: true
    publish_frequency: 1.0          # Hz

  diagnostics:
    enable_diagnostics: true
    check_frequency: 2.0            # Hz

  logging:
    level: "INFO"                   # DEBUG, INFO, WARN, ERROR
    verbose: false

# ============================================================================
# PGO (位姿图优化) 配置
# ============================================================================
pgo:
  # 基本话题配置
  cloud_topic: "/localizer/filtered_cloud"
  odom_topic: "/slam/lio_odom"
  map_frame: "map"
  local_frame: "lidar"

  # 关键帧选择参数 (室内建图优化)
  key_pose_delta_deg: 10            # 角度阈值 (度)
  key_pose_delta_trans: 0.3         # 平移阈值 (米，室内密集关键帧)

  # 回环检测参数 (室内优化)
  loop_search_radius: 2.5           # 回环搜索半径 (米，扩大室内搜索)
  loop_time_tresh: 30.0             # 回环时间阈值 (秒，更频繁检测)
  loop_score_tresh: 0.15            # 回环匹配分数阈值

  # 子地图参数
  loop_submap_half_range: 5         # 子地图半径
  submap_resolution: 0.1            # 子地图分辨率 (米)
  min_loop_detect_duration: 5.0     # 最小回环检测间隔 (秒)

# ============================================================================
# HBA (层次化捆绑调整) 配置
# ============================================================================
hba:
  # 扫描分辨率
  scan_resolution: 0.1              # 扫描分辨率 (米)

  # 滑动窗口参数
  window_size: 20                   # 窗口大小
  stride: 10                        # 步长

  # 点云处理参数
  voxel_size: 0.5                   # 体素大小 (米)
  min_point_num: 10                 # 最小点数
  max_layer: 3                      # 最大层数

  # 优化参数
  plane_thresh: 0.01                # 平面阈值
  ba_max_iter: 10                   # BA最大迭代次数
  hba_iter: 5                       # HBA迭代次数
  down_sample: 0.1                  # 下采样分辨率

# ============================================================================
# Localizer (定位器) 配置
# ============================================================================
localizer:
  # 基本话题配置
  # 订阅来自FAST-LIO2的原始身体坐标系点云（经cooperative启动重映射为/slam/body_cloud）
  cloud_topic: "/slam/body_cloud"
  odom_topic: "/slam/lio_odom"
  map_frame: "map"
  local_frame: "lidar"
  update_hz: 1.0                    # 更新频率 (Hz)

  # 粗定位参数
  rough_localization:
    scan_resolution: 0.25           # 粗扫描分辨率 (米)
    map_resolution: 0.25            # 粗地图分辨率 (米)
    max_iteration: 5                # 最大迭代次数
    score_thresh: 0.2               # 匹配分数阈值

  # 精细定位参数
  refine_localization:
    scan_resolution: 0.1            # 精细扫描分辨率 (米)
    map_resolution: 0.1             # 精细地图分辨率 (米)
    max_iteration: 10               # 最大迭代次数
    score_thresh: 0.1               # 匹配分数阈值

  # 动态对象过滤器配置
  # 基于多帧时间一致性和几何特征分析的混合动态对象检测算法
  # 用于在SLAM过程中实时过滤动态物体，提高定位和建图精度
  dynamic_filter:
    enable: false                   # 禁用Localizer动态过滤（FastLIO2输入已使用专用过滤桥接节点过滤）
                                    # 避免重复过滤，保持数据流一致性

    publish_stats: true             # 是否发布过滤统计信息到ROS话题
                                    # 包括过滤点数、处理时间、动态对象数量等性能指标

    # ========================================================================
    # 时间一致性分析参数
    # 通过跟踪点在多帧间的位置变化来识别动态对象
    # ========================================================================
    motion_threshold: 0.1           # 点运动检测阈值 (单位: 米)
                                    # 点在相邻帧间移动距离超过此值被标记为运动点
                                    # 推荐范围: 0.05-0.2m，室内环境用较小值

    history_size: 5                 # 时间历史窗口大小 (单位: 帧数)
                                    # 用于计算点的时间稳定性，帧数越多检测越准确但延迟增加
                                    # 推荐范围: 3-10帧，LiDAR频率10Hz时对应0.3-1.0秒

    stability_threshold: 0.8        # 点稳定性判定阈值 (范围: 0-1)
                                    # 点在历史帧中静止比例超过此值被认为是静态
                                    # 0.8表示80%的历史帧中保持静止才认为是静态点

    max_time_diff: 0.5              # 点云帧间最大时间差限制 (单位: 秒)
                                    # 超过此时间差的历史帧将被丢弃，避免过旧数据影响判断
                                    # 推荐设置为2-5倍的传感器采样周期

    # ========================================================================
    # 几何特征一致性参数
    # 通过分析点的局部几何特征（法向量、点密度）验证动态检测结果
    # ========================================================================
    search_radius: 0.2              # K近邻搜索半径 (单位: 米)
                                    # 用于计算每个点的局部几何特征的邻域范围
                                    # 应根据点云密度调整，密集点云用较小值

    min_neighbors: 10               # 几何特征计算所需的最小邻居点数
                                    # 邻居数不足时跳过几何验证，避免不可靠的特征计算
                                    # 推荐范围: 5-20个点

    normal_consistency_thresh: 0.8  # 法向量一致性验证阈值 (范围: 0-1)
                                    # 点与邻域法向量夹角余弦值超过此阈值认为几何一致
                                    # 0.8对应约36度角度差，可过滤表面不连续的噪声点

    density_ratio_thresh: 0.5       # 局部点密度比值阈值 (范围: 0-1)
                                    # 当前帧与历史帧局部密度比值，低于此值可能是动态对象
                                    # 0.5表示密度降低超过50%时标记为可疑动态区域

    # ========================================================================
    # 性能优化参数
    # 在保证检测精度的前提下优化算法的计算效率和内存使用
    # ========================================================================
    downsample_ratio: 2             # 输入点云降采样比例 (整数倍)
                                    # 每隔N个点取1个点进行处理，减少计算量
                                    # 1=不降采样，2=保留50%点，4=保留25%点

    max_points_per_frame: 50000     # 单帧处理的最大点数限制
                                    # 超过此数量时进行随机采样，防止计算量过大
                                    # 根据硬件性能调整：强CPU可设置更高值

    voxel_size_base: 0.01           # 体素化网格基础大小 (单位: 米)
                                    # 用于点云预处理和邻域搜索加速
                                    # 较小值保留更多细节但增加计算量

# ============================================================================
# 协同优化配置
# ============================================================================
cooperation:
  # 协同优化开关
  enable: true                      # 启用协同优化

  # 漂移检测参数
  drift_threshold: 0.5              # 漂移检测阈值 (米)
  time_threshold: 60.0              # 时间触发阈值 (秒)
  emergency_threshold: 2.0          # 紧急优化阈值 (米)
  auto_optimization: true           # 自动优化开关

  # 多机协同参数 (预留)
  multi_agent:
    max_agents: 4                   # 最大机器人数量
    communication_freq: 5.0         # 通信频率 (Hz)

# ============================================================================
# 配置验证规则
# ============================================================================
validation:
  # 自动检查项目
  checks:
    network_connectivity: true
    calibration_consistency: true
    topic_availability: true
    parameter_ranges: true

  # 参数约束
  constraints:
    lidar_max_range:
      min: 1.0
      max: 100.0
    publish_freq:
      min: 1.0
      max: 50.0
    imu_init_num:
      min: 50
      max: 1000
